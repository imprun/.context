# Story 20.10: Policy Scope ì„¤ì • UI

## ê°œìš”

| í•­ëª© | ë‚´ìš© |
|------|------|
| **Story ID** | 20.10 |
| **Epic** | EPIC-020 (Route & Policy ì„¤ì •) |
| **ìš°ì„ ìˆœìœ„** | P0 |
| **ì˜ˆìƒ ê³µìˆ˜** | 0.5ì¼ |
| **ìƒíƒœ** | ğŸ”² ë¯¸ì‹œì‘ |
| **ë‹´ë‹¹ì** | - |

## ëª©í‘œ

Policyì˜ ì ìš© ë²”ìœ„(Scope)ë¥¼ Global, Service, Route ë‹¨ìœ„ë¡œ ì„¤ì •í•  ìˆ˜ ìˆëŠ” UIë¥¼ ì œê³µí•œë‹¤.

## ì˜ì¡´ì„±

- Story 20.3 (Policy ì—”í‹°í‹°)
- Story 20.7 (Policy Type Selector)

## ìš”êµ¬ì‚¬í•­

### ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

1. **Scope ì„ íƒ UI**
   - Global: ëª¨ë“  Routeì— ì ìš©
   - Service: íŠ¹ì • API Serviceì˜ ëª¨ë“  Routeì— ì ìš©
   - Route: íŠ¹ì • Routeì—ë§Œ ì ìš©

2. **Scopeë³„ ë¦¬ì†ŒìŠ¤ ì„ íƒ**
   - Service scope: API Service ë“œë¡­ë‹¤ìš´
   - Route scope: Route ë“œë¡­ë‹¤ìš´ (Service ì„ íƒ í›„)

3. **Scope ìš°ì„ ìˆœìœ„ í‘œì‹œ**
   - Route > Service > Global ìˆœìœ¼ë¡œ ì ìš©
   - ë™ì¼ íƒ€ì… Policyê°€ ì—¬ëŸ¬ scopeì— ìˆì„ ë•Œ ìš°ì„ ìˆœìœ„ í‘œì‹œ

4. **Scope ë³€ê²½**
   - ê¸°ì¡´ Policyì˜ scope ë³€ê²½ ê°€ëŠ¥
   - ë³€ê²½ ì‹œ ì˜í–¥ ë²”ìœ„ ê²½ê³ 

### ë¹„ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

- Scope ë³€ê²½ ì‹œ ì˜í–¥ë°›ëŠ” Route ìˆ˜ í‘œì‹œ
- ì§ê´€ì ì¸ ê³„ì¸µ êµ¬ì¡° ì‹œê°í™”

## ê¸°ìˆ  ìƒì„¸

### Policy Scope ë°ì´í„° ëª¨ë¸

```typescript
interface Policy {
  id: string;
  name: string;
  type: string;

  // Scope
  scope: 'global' | 'service' | 'route';
  api_service_id?: string;  // scopeê°€ 'service' ë˜ëŠ” 'route'ì¼ ë•Œ
  route_id?: string;        // scopeê°€ 'route'ì¼ ë•Œ

  spec: Record<string, any>;
  enabled: boolean;
}
```

### Scope ì„ íƒ UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Policy Scope                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Apply this policy to:                                                  â”‚
â”‚                                                                         â”‚
â”‚  â—‹ Global                                                               â”‚
â”‚    â””â”€ All routes across all services (lowest priority)                  â”‚
â”‚       Affects: 42 routes                                                â”‚
â”‚                                                                         â”‚
â”‚  â— Service                                                              â”‚
â”‚    â””â”€ All routes in a specific service                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚       â”‚ [â–¼ Select Service]                                          â”‚   â”‚
â”‚       â”‚   â”œâ”€ payment-api (12 routes)                                â”‚   â”‚
â”‚       â”‚   â”œâ”€ user-api (8 routes)                                    â”‚   â”‚
â”‚       â”‚   â””â”€ order-api (15 routes)                                  â”‚   â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       Affects: 12 routes                                                â”‚
â”‚                                                                         â”‚
â”‚  â—‹ Route                                                                â”‚
â”‚    â””â”€ A specific route only (highest priority)                          â”‚
â”‚       Service: [â–¼ payment-api        ]                                  â”‚
â”‚       Route:   [â–¼ Select Route       ]                                  â”‚
â”‚                  â”œâ”€ POST /payments                                      â”‚
â”‚                  â”œâ”€ GET /payments/:id                                   â”‚
â”‚                  â””â”€ GET /payments                                       â”‚
â”‚       Affects: 1 route                                                  â”‚
â”‚                                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                         â”‚
â”‚  â„¹ï¸ Priority: Route policies override Service policies,                 â”‚
â”‚     which override Global policies.                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Policy ìš°ì„ ìˆœìœ„ ì‹œê°í™”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rate Limit Policies Applied to: GET /users                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Priority    Scope      Name              Config         Status         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1 (active)  Route      user-rate-limit   100 req/min    â— Applied      â”‚
â”‚  2           Service    api-rate-limit    500 req/min    â—‹ Overridden   â”‚
â”‚  3           Global     global-limit      1000 req/min   â—‹ Overridden   â”‚
â”‚                                                                         â”‚
â”‚  â„¹ï¸ Route-level policy "user-rate-limit" is currently active.          â”‚
â”‚     Other policies are overridden by higher priority policies.          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scope ë³€ê²½ ê²½ê³ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ Change Policy Scope                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ You are changing the scope of "api-rate-limit" from:                    â”‚
â”‚                                                                         â”‚
â”‚   Service (payment-api) â†’ Global                                        â”‚
â”‚                                                                         â”‚
â”‚ This will affect:                                                       â”‚
â”‚   â€¢ Currently: 12 routes in payment-api                                 â”‚
â”‚   â€¢ After change: 42 routes across all services                         â”‚
â”‚                                                                         â”‚
â”‚ âš ï¸ This may override existing route-level policies.                     â”‚
â”‚                                                                         â”‚
â”‚                                    [Cancel] [Confirm Change]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### êµ¬í˜„ ìœ„ì¹˜

```
web/src/features/policy/
â”œâ”€â”€ create-policy/
â”‚   â””â”€â”€ ui/
â”‚       â””â”€â”€ policy-scope-selector.tsx    # Scope ì„ íƒ ì»´í¬ë„ŒíŠ¸
â”œâ”€â”€ update-policy/
â”‚   â””â”€â”€ ui/
â”‚       â””â”€â”€ policy-scope-editor.tsx      # Scope ë³€ê²½ + ê²½ê³ 
â””â”€â”€ lib/
    â””â”€â”€ policy-scope-utils.ts            # ì˜í–¥ ë²”ìœ„ ê³„ì‚°

web/src/widgets/provider/
â””â”€â”€ policy-priority-view/
    â””â”€â”€ index.tsx                        # ìš°ì„ ìˆœìœ„ ì‹œê°í™”
```

### API ìš”ì²­

```typescript
// Policy ìƒì„± ì‹œ scope ì§€ì •
await createPolicy.mutateAsync({
  name: 'rate-limit',
  type: 'rate-limit',
  scope: 'service',
  api_service_id: 'service-123',
  spec: { requests_per_unit: 100, unit: 'minute' },
  enabled: true,
});

// Scope ë³€ê²½
await updatePolicy.mutateAsync({
  id: 'policy-123',
  scope: 'global',
  api_service_id: null,  // globalì´ë¯€ë¡œ null
  route_id: null,
});
```

## ìˆ˜ìš© ê¸°ì¤€

- [ ] Policy ìƒì„± ì‹œ scopeë¥¼ ì„ íƒí•  ìˆ˜ ìˆë‹¤ (Global/Service/Route)
- [ ] Service scope ì„ íƒ ì‹œ Service ëª©ë¡ì´ í‘œì‹œëœë‹¤
- [ ] Route scope ì„ íƒ ì‹œ Service â†’ Route ìˆœìœ¼ë¡œ ì„ íƒí•œë‹¤
- [ ] ì„ íƒí•œ scopeì— ë”°ë¥¸ ì˜í–¥ ë²”ìœ„(route ìˆ˜)ê°€ í‘œì‹œëœë‹¤
- [ ] ê¸°ì¡´ Policyì˜ scopeë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤
- [ ] Scope ë³€ê²½ ì‹œ ì˜í–¥ ë²”ìœ„ ê²½ê³ ê°€ í‘œì‹œëœë‹¤
- [ ] ë™ì¼ íƒ€ì… Policyì˜ ìš°ì„ ìˆœìœ„ê°€ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œëœë‹¤

## ì°¸ì¡°

- Envoy Gateway Policy Attachment: https://gateway.envoyproxy.io/docs/tasks/security/
- Story 20.7 (Policy Type Selector)
- Story 20.3 (Policy ì—”í‹°í‹°)
